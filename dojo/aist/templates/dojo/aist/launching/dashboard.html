{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <h3 class="no-margin-top">{% trans "Launch Scheduling" %}</h3>
            <div class="alert" id="launch-dashboard-toast" style="display:none;"></div>

            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#tab-schedules">{% trans "Schedules" %}</a></li>
                <li><a data-toggle="tab" href="#tab-queue">{% trans "Queue" %}</a></li>
                <li><a data-toggle="tab" href="#tab-launch-configs">{% trans "Launch configs" %}</a></li>
                <li><a data-toggle="tab" href="#tab-create">{% trans "Create / Update schedule" %}</a></li>
            </ul>

            <div class="tab-content" style="margin-top: 15px;">

                <!-- SCHEDULES -->
                <div id="tab-schedules" class="tab-pane fade in active">

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <strong>{% trans "Schedules" %}</strong>
                        </div>
                        <div class="panel-body">

                            <form class="form-inline" id="schedules-filters" style="margin-bottom: 10px;">
                                <div class="form-group">
                                    <label for="filter-org">{% trans "Organization" %}</label>
                                    <select id="filter-org" class="form-control">
                                        <option value="">{% trans "All" %}</option>
                                        {% for o in organizations %}
                                            <option value="{{ o.id }}">{{ o.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group" style="margin-left: 10px;">
                                    <label for="filter-project">{% trans "Project" %}</label>
                                    <select id="filter-project" class="form-control">
                                        <option value="">{% trans "All" %}</option>
                                        {% for p in projects %}
                                            <option value="{{ p.id }}">{{ p.product.name }} — {{ p.organization.name }}
                                                (#{{ p.id }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group" style="margin-left: 10px;">
                                    <label for="filter-enabled">{% trans "Enabled" %}</label>
                                    <select id="filter-enabled" class="form-control">
                                        <option value="">{% trans "All" %}</option>
                                        <option value="1">{% trans "Enabled" %}</option>
                                        <option value="0">{% trans "Disabled" %}</option>
                                    </select>
                                </div>

                                <button type="button" class="btn btn-primary" style="margin-left: 10px;"
                                        id="btn-refresh-schedules">
                                    {% trans "Refresh" %}
                                </button>

                                <div class="pull-right">
                                    <button type="button" class="btn btn-danger" id="btn-bulk-disable-org">
                                        {% trans "Disable all for org" %}
                                    </button>
                                    <button type="button" class="btn btn-danger" id="btn-bulk-disable-project">
                                        {% trans "Disable all for project" %}
                                    </button>
                                </div>
                            </form>

                            <table id="tbl-schedules" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                <tr>
                                    <th>{% trans "Project" %}</th>
                                    <th>{% trans "Launch config" %}</th>
                                    <th>{% trans "Cron" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Due tick" %}</th>
                                    <th>{% trans "Next tick" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>

                            <p class="text-muted" style="margin-top: 10px;">
                                {% trans "Note: 'Due now' means schedule is enabled and the due tick is within the last 2 minutes." %}
                            </p>

                        </div>
                    </div>
                </div>

                <!-- QUEUE -->
                <div id="tab-queue" class="tab-pane fade">

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <strong>{% trans "Launch Queue" %}</strong>
                        </div>
                        <div class="panel-body">

                            <form class="form-inline" id="queue-filters" style="margin-bottom: 10px;">
                                <div class="queue-filters__row">
                                    <div class="queue-filters__left">
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" id="queue-only-pending">
                                                {% trans "Only pending (dispatched=false)" %}
                                            </label>
                                        </div>

                                        <button type="button" class="btn btn-primary" id="btn-refresh-queue">
                                            {% trans "Refresh" %}
                                        </button>
                                    </div>

                                    <div class="queue-filters__right">
                                        <div class="form-group">
                                            <label for="clear-days">{% trans "Clear dispatched older than (days)" %}</label>
                                            <input type="number" min="1" max="365" value="14" id="clear-days"
                                                   class="form-control" style="width: 90px;">
                                        </div>
                                        <button type="button" class="btn btn-warning" id="btn-clear-dispatched">
                                            {% trans "Clear" %}
                                        </button>
                                    </div>
                                </div>

                                <div class="queue-filters__row">
                                    <div class="queue-filters__dt"></div>
                                </div>
                            </form>

                            <table id="tbl-queue" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                <tr>
                                    <th>{% trans "Created" %}</th>
                                    <th>{% trans "Project" %}</th>
                                    <th>{% trans "Schedule" %}</th>
                                    <th>{% trans "Launch config" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Pipeline" %}</th>
                                    <th>{% trans "Age" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>

                        </div>
                    </div>
                </div>

                <!-- LAUNCH CONFIGS -->
                <div id="tab-launch-configs" class="tab-pane fade">

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <strong>{% trans "Launch configs" %}</strong>
                        </div>
                        <div class="panel-body">

                            <form class="form-inline" id="launch-configs-filters" style="margin-bottom: 10px;">
                                <div class="queue-filters__row">
                                    <div class="queue-filters__left">
                                        <div class="form-group">
                                            <label for="filter-lc-org">{% trans "Organization" %}</label>
                                            <select id="filter-lc-org" class="form-control">
                                                <option value="">{% trans "All" %}</option>
                                                {% for o in organizations %}
                                                    <option value="{{ o.id }}">{{ o.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="form-group" style="margin-left: 10px;">
                                            <label for="filter-lc-project">{% trans "Project" %}</label>
                                            <select id="filter-lc-project" class="form-control">
                                                <option value="">{% trans "All" %}</option>
                                                {% for p in projects %}
                                                    <option value="{{ p.id }}">{{ p.product.name }} — {{ p.organization.name }}
                                                        (#{{ p.id }})
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="form-group" style="margin-left: 10px;">
                                            <label for="filter-lc-default">{% trans "Default" %}</label>
                                            <select id="filter-lc-default" class="form-control">
                                                <option value="">{% trans "All" %}</option>
                                                <option value="1">{% trans "Default" %}</option>
                                                <option value="0">{% trans "Not default" %}</option>
                                            </select>
                                        </div>

                                        <button type="button" class="btn btn-primary" style="margin-left: 10px;"
                                                id="btn-refresh-launch-configs">
                                            {% trans "Refresh" %}
                                        </button>
                                    </div>

                                    <div class="queue-filters__right">
                                        <span class="text-muted small">
                                            {% trans "Click a row to view params and actions. Secrets are hidden." %}
                                        </span>
                                    </div>
                                </div>

                                <div class="queue-filters__row">
                                    <div class="queue-filters__dt"></div>
                                </div>
                            </form>

                            <table id="tbl-launch-configs" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                <tr>
                                    <th></th>
                                    <th>{% trans "Project" %}</th>
                                    <th>{% trans "Launch config" %}</th>
                                    <th>{% trans "Default" %}</th>
                                    <th>{% trans "Updated" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                    <th>{% trans "Description" %}</th>
                                    <th>{% trans "Manage" %}</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>

                        </div>
                    </div>
                </div>

                <!-- CREATE / UPDATE -->
                <div id="tab-create" class="tab-pane fade">

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <strong>{% trans "Create / Update LaunchSchedule" %}</strong>
                        </div>
                        <div class="panel-body">
                            <p class="text-muted">
                                {% trans "This form uses the same backend API as external clients. UI does not implement scheduling logic." %}
                            </p>

                            <form id="schedule-form" class="form-horizontal">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label class="col-sm-2 control-label"
                                           for="form-project">{% trans "Project" %}</label>
                                    <div class="col-sm-6">
                                        <select id="form-project"
                                                class="form-control selectpicker"
                                                data-live-search="true"
                                                data-width="100%">
                                            <option value="">{% trans "Select project" %}</option>
                                            {% for p in projects %}
                                                <option value="{{ p.id }}">{{ p.product.name }}
                                                    — {{ p.organization.name }} (#{{ p.id }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label"
                                           for="form-launch-config">{% trans "Launch config" %}</label>
                                    <div class="col-sm-6">
                                        <select id="form-launch-config"
                                                class="form-control selectpicker"
                                                data-live-search="true"
                                                data-width="100%"
                                                disabled>
                                            <option value="">{% trans "Select project first" %}</option>
                                        </select>

                                        <span class="help-block">
                    {% trans "Select a LaunchConfig belonging to the selected project." %}
                  </span>
                                    </div>
                                </div>

                                <!-- CRON INPUT + PRESETS + INLINE PREVIEW (backend-calculated) -->
                                <div class="form-group">
                                    <label class="col-sm-2 control-label"
                                           for="form-cron">{% trans "Cron expression" %}</label>
                                    <div class="col-sm-6">

                                        <div class="input-group" style="width: 100%;">
                                            <span class="input-group-addon" style="width: 170px;">
                                                <select id="form-cron-preset" class="form-control" style="width: 100%;">
                                                    <option value="">{% trans "Preset…" %}</option>
                                                    <option value="*/5 * * * *">{% trans "Every 5 minutes" %}</option>
                                                    <option value="0 * * * *">{% trans "Hourly (minute 0)" %}</option>
                                                    <option value="0 3 * * *">{% trans "Daily at 03:00" %}</option>
                                                    <option value="45 13 * * 5">{% trans "Friday at 13:45" %}</option>
                                                    <option value="0 9 * * 1-5">{% trans "Weekdays at 09:00" %}</option>
                                                </select>
                                            </span>
                                            <input id="form-cron" class="form-control" placeholder="e.g. */5 * * * *">
                                        </div>

                                        <span class="help-block">
                                            {% trans "5-field cron: minute hour day-of-month month day-of-week. Example: every 5 minutes: */5 * * * *" %}
                                            <br>
                                            <span class="text-muted">{% trans "Preview below is calculated by backend; UI does not implement scheduling logic." %}</span>
                                        </span>

                                        <div id="cron-inline-preview" class="well well-sm"
                                             style="margin-top: 8px; display: none;">
                                            <div>
                                                <strong>{% trans "Next runs" %}</strong>
                                                <span class="text-muted" id="cron-inline-tz"></span>
                                            </div>
                                            <ul id="cron-inline-runs" style="margin: 6px 0 0 18px;"></ul>
                                        </div>

                                        <div id="cron-inline-error" class="alert alert-danger"
                                             style="margin-top: 8px; display: none;"></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label"
                                           for="form-enabled">{% trans "Enabled" %}</label>
                                    <div class="col-sm-6">
                                        <select id="form-enabled" class="form-control">
                                            <option value="1">{% trans "Enabled" %}</option>
                                            <option value="0">{% trans "Disabled" %}</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label"
                                           for="form-max-conc">{% trans "Max concurrent / worker" %}</label>
                                    <div class="col-sm-6">
                                        <input id="form-max-conc" type="number" min="1" max="8" class="form-control"
                                               value="1">
                                        <span class="help-block">{% trans "Must be >= 1. Controls how many pipelines can run concurrently per worker." %}</span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="col-sm-offset-2 col-sm-6">
                                        <button type="button" class="btn btn-success" id="btn-save-schedule">
                                            {% trans "Save schedule (upsert)" %}
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block postscript %}
    <style>
        /* --- Create/Update: align Cron preset select height with input --- */
        #tab-create #form-cron-preset {
            height: 34px;
            line-height: 34px;
            padding-top: 6px;
            padding-bottom: 6px;
        }

        #tab-create .input-group-addon {
            padding: 0;
        }

        /* If bootstrap-select upgrades this <select> to a button, align that too */
        #tab-create .input-group-addon .bootstrap-select > .btn {
            height: 34px;
            padding-top: 6px;
            padding-bottom: 6px;
        }

        /*
         * Make filter toolbars a single row.
         * DataTables length/search controls are moved into these forms via JS below.
         */
        #schedules-filters,
        #queue-filters {
            display: flex;
            align-items: flex-end;
            flex-wrap: nowrap;
            gap: 10px;
        }

        /* Bootstrap's pull-right (float) breaks flex toolbars. Override only inside our forms. */
        #schedules-filters .pull-right,
        #queue-filters .pull-right {
            float: none !important;
            margin-left: auto;
            display: flex;
            align-items: flex-end;
            flex-wrap: nowrap;
            gap: 10px;
        }

        #schedules-filters .form-group,
        #queue-filters .form-group {
            margin: 0;
        }

        /* Bootstrap .checkbox has its own margins/padding that don't play well with flex toolbars. */
        #queue-filters .checkbox {
            margin: 0;
        }

        #queue-filters .checkbox label {
            padding-top: 0;
        }

        /* Queue toolbar layout */
        #queue-filters {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        #queue-filters .queue-filters__row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        #queue-filters .queue-filters__left,
        #queue-filters .queue-filters__right,
        #queue-filters .queue-filters__dt {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        #queue-filters .queue-filters__right {
            margin-left: auto;
        }

        #queue-filters .queue-filters__dt {
            margin-left: auto;
        }

        #queue-filters .queue-filters__right .form-group,
        #queue-filters .queue-filters__dt .form-group {
            margin: 0;
        }

        #queue-filters .dataTables_length,
        #queue-filters .dataTables_filter {
            margin: 0;
        }

        /* DataTables controls, once moved into the forms, should behave like inline form items. */
        #schedules-filters .dataTables_length,
        #schedules-filters .dataTables_filter,
        #queue-filters .dataTables_length,
        #queue-filters .dataTables_filter {
            float: none !important;
            width: auto !important;
            margin: 0;
            display: flex;
            align-items: flex-end;
        }

        #schedules-filters .dataTables_length label,
        #schedules-filters .dataTables_filter label,
        #queue-filters .dataTables_length label,
        #queue-filters .dataTables_filter label {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
        }

        #tbl-launch-configs .details-control {
            cursor: pointer;
            width: 32px;
        }

        .launch-config-details {
            display: flex;
            gap: 16px;
            background: #fafafa;
            border: 1px solid #e5e5e5;
            padding: 12px;
            border-radius: 4px;
        }

        .launch-config-details__col {
            flex: 1;
            min-width: 0;
        }

        .launch-config-details pre {
            margin: 0;
            max-height: 260px;
            overflow: auto;
            white-space: pre-wrap;
        }

        #tbl-launch-configs tr.group {
            background: #f5f5f5;
            font-weight: 600;
            cursor: pointer;
        }

        #tbl-launch-configs tr.group td {
            padding: 8px 10px;
        }

        @media (max-width: 992px) {
            .launch-config-details {
                flex-direction: column;
            }
        }
    </style>

    <script>
        (function () {
            // ---------------------------
            // CONFIG (URLs from Django context)
            // ---------------------------
            var URL_SCHEDULES_LIST = "{{ api_launch_schedules_url }}";
            var URL_SCHEDULE_UPSERT_TPL = "{{ api_project_schedule_upsert_template }}";
            var URL_PREVIEW = "{{ api_preview_url }}";
            var URL_QUEUE = "{{ api_queue_url }}";
            var URL_QUEUE_CLEAR = "{{ api_queue_clear_url }}";
            var URL_QUEUE_DELETE_TPL = "{{ api_queue_delete_template }}";
            var URL_BULK_DISABLE = "{{ api_bulk_disable_url }}";
            var URL_PROJECT_LAUNCH_CONFIGS_TPL = "{{ api_project_launch_configs_template }}";
            var URL_LAUNCH_CONFIGS_DASHBOARD = "{{ api_launch_configs_dashboard_url }}";
            var URL_LAUNCH_CONFIG_DELETE_TPL = "{{ api_launch_config_delete_template }}";
            var URL_SCHEDULE_RUN_ONCE_TPL = "{{ api_schedule_run_once_template }}";
            var URL_PIPELINE_DETAIL_TPL = "{{ ui_pipeline_detail_template }}";
            var URL_SCHEDULE_DELETE_TPL = "{{ api_schedule_delete_template }}";
            // Translated UI strings (keep all user-facing text in one place).
            // IMPORTANT: keep Django "trans" tag arguments intact; use single-quoted JS strings.
            var TXT_SELECT_PROJECT_FIRST = '{% trans "Select project first" %}';
            var TXT_NO_LAUNCH_CONFIGS = '{% trans "No launch configs for this project" %}';
            var TXT_SELECT_LAUNCH_CONFIG = '{% trans "Select launch config" %}';

            function getCookie(name) {
                var value = "; " + document.cookie;
                var parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
                return "";
            }

            function getCsrfToken() {
                // Prefer cookie (Django default), but also support hidden input fallback.
                var token = getCookie("csrftoken");
                if (token) return token;

                var el = document.querySelector('input[name="csrfmiddlewaretoken"]');
                if (el && el.value) return el.value;

                return "";
            }

            function csrfHeaders() {
                var token = getCsrfToken();
                // IMPORTANT: never send an empty token header (it triggers CSRF "incorrect length").
                if (!token) return {};
                return {"X-CSRFToken": token};
            }

            function fmtDate(v) {
                if (!v) return "";
                try {
                    return new Date(v).toLocaleString();
                } catch (e) {
                    return String(v);
                }
            }

            function fmtAge(seconds) {
                seconds = parseInt(seconds || 0, 10);
                var m = Math.floor(seconds / 60);
                var h = Math.floor(m / 60);
                var d = Math.floor(h / 24);
                if (d > 0) return d + "d " + (h % 24) + "h";
                if (h > 0) return h + "h " + (m % 60) + "m";
                if (m > 0) return m + "m";
                return seconds + "s";
            }

            function parseListResponse(data) {
                // Be tolerant: API may return {results:[...]} or plain list
                if (!data) return [];
                if (Array.isArray(data)) return data;
                if (Array.isArray(data.results)) return data.results;
                if (Array.isArray(data.items)) return data.items;
                return [];
            }

            function showToast(message, kind) {
                var el = document.getElementById("launch-dashboard-toast");
                if (!el) return;
                el.className = "alert alert-" + (kind || "success");
                el.textContent = message;
                el.style.display = "block";
                setTimeout(function () {
                    el.style.display = "none";
                }, 3000);
            }

            function statusBadge(enabled, dueNow) {
                if (!enabled) return '<span class="label label-default">Disabled</span>';
                if (dueNow) return '<span class="label label-danger">Due now</span> <span class="label label-success">Enabled</span>';
                return '<span class="label label-success">Enabled</span>';
            }

            // ---------------------------
            // CREATE FORM: Launch configs dropdown
            // ---------------------------
            var cachedLaunchConfigsByProject = {}; // project_id -> array

            function escapeHtml(s) {
                return String(s || "")
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function ensureSelectPicker($el) {
                // Graceful fallback:
                // If bootstrap-select isn't loaded, make sure the native <select> stays visible.
                if (typeof $el.selectpicker !== "function") {
                    $el.removeClass("selectpicker");
                    $el.css("display", "");         // undo any accidental display:none
                    $el.css("visibility", "");      // undo any accidental visibility:hidden
                    return;
                }
                if (!$el.data("selectpicker")) {
                    $el.selectpicker(); // use data-* attributes from HTML
                } else {
                    $el.selectpicker("refresh");
                }
            }

            function refreshLaunchConfigSelectpicker($sel) {
                // When bootstrap-select is in use, the visible dropdown button won't update
                // unless we call refresh after changing <option>s or disabled state.
                if (typeof $sel.selectpicker === "function") {
                    // Some bootstrap-select versions need 'render' in addition to 'refresh'
                    // to update the button text after we replace <option> list.
                    $sel.selectpicker("render");
                    $sel.selectpicker("refresh");
                }
            }

            function setLaunchConfigsSelect(items, emptyText) {
                var sel = $("#form-launch-config");
                sel.empty();

                if (!items || items.length === 0) {
                    sel.append('<option value="">' + escapeHtml(emptyText || TXT_NO_LAUNCH_CONFIGS) + '</option>');
                    sel.prop("disabled", true);
                    ensureSelectPicker(sel);
                    refreshLaunchConfigSelectpicker(sel);
                    return;
                }

                sel.append('<option value="">' + escapeHtml(TXT_SELECT_LAUNCH_CONFIG) + '</option>');
                items.forEach(function (cfg) {
                    var label = (cfg.name ? cfg.name : ("#" + cfg.id));
                    if (cfg.is_default) label += " (default)";
                    sel.append('<option value="' + cfg.id + '">' + escapeHtml(label) + '</option>');
                });

                sel.prop("disabled", false);

                // Prefer default config if present
                var def = items.find(function (x) {
                    return !!x.is_default;
                });
                if (def) {
                    sel.val(String(def.id));
                }

                ensureSelectPicker(sel);
                refreshLaunchConfigSelectpicker(sel);
            }

            function loadLaunchConfigsForProject(projectId) {
                projectId = String(projectId || "").trim();
                if (!projectId) {
                    setLaunchConfigsSelect([], TXT_SELECT_PROJECT_FIRST);
                    return;
                }

                if (cachedLaunchConfigsByProject[projectId]) {
                    setLaunchConfigsSelect(cachedLaunchConfigsByProject[projectId]);
                    return;
                }

                var url = URL_PROJECT_LAUNCH_CONFIGS_TPL.replace("{project_id}", projectId);
                fetch(url, {credentials: "same-origin"})
                    .then(function (r) {
                        if (!r.ok) throw new Error("Failed to load launch configs");
                        return r.json();
                    })
                    .then(function (data) {
                        var items = parseListResponse(data);
                        cachedLaunchConfigsByProject[projectId] = items;
                        setLaunchConfigsSelect(items);
                    })
                    .catch(function (err) {
                        console.error(err);
                        setLaunchConfigsSelect([], TXT_NO_LAUNCH_CONFIGS);
                        alert("Failed to load launch configs for project " + projectId);
                    });
            }

            function onProjectChanged() {
                // For bootstrap-select, use the underlying <select> value after it syncs.
                var projectId = $("#form-project").val();
                loadLaunchConfigsForProject(projectId);
            }

            // Support both plain select and bootstrap-select event
            $("#form-project").on("changed.bs.select", onProjectChanged);
            $("#form-project").on("change", onProjectChanged);

            // Ensure pickers are initialized/synced (prevents "UI shows one item, value is another")
            ensureSelectPicker($("#form-project"));

            // ---------------------------
            // DataTables: move built-in controls into our filter toolbars
            // ---------------------------
            function moveDataTablesControls(dt, $filtersForm) {
                if (!dt || !$filtersForm || $filtersForm.length === 0) return;

                var $wrapper = $(dt.table().container()); // ..._wrapper

                // DataTables/Bootstrap wrappers vary across versions. Don't assume exact structure.
                // Find the controls anywhere inside the wrapper, then move them into our toolbar.
                var $len = $wrapper.find('.dataTables_length').first();
                var $filter = $wrapper.find('.dataTables_filter').first();
                if ($len.length === 0 && $filter.length === 0) return;

                // Remember the original DataTables row that contained the controls, so we can clean it up.
                var $origDtRow = null;
                if ($len.length) $origDtRow = $len.closest('.row');
                if ((!$origDtRow || $origDtRow.length === 0) && $filter.length) $origDtRow = $filter.closest('.row');

                var $left = $filtersForm.find('.queue-filters__left').first();
                var $right = $filtersForm.find('.queue-filters__right').first();
                var $dtRow = $filtersForm.find('.queue-filters__dt').first();

                // Fallback for schedules toolbar (uses .pull-right)
                if ($right.length === 0) {
                    $right = $filtersForm.find('.pull-right').first();
                }
                if ($right.length === 0) {
                    $right = $('<div class="pull-right"></div>').appendTo($filtersForm);
                }

                if ($len.length) {
                    if ($dtRow.length) {
                        $len.appendTo($dtRow);
                    } else if ($left.length) {
                        $len.appendTo($left);
                    } else {
                        $len.insertBefore($right);
                    }
                    $len.css({float: 'none', width: 'auto'});
                }

                if ($filter.length) {
                    if ($dtRow.length) {
                        $filter.appendTo($dtRow);
                    } else if ($right.length) {
                        $filter.appendTo($right);
                    } else {
                        $filter.appendTo($filtersForm);
                    }
                    $filter.css({float: 'none', width: 'auto'});
                }

                // Remove the original DataTables top row if it's now empty (avoid extra vertical whitespace).
                if ($origDtRow && $origDtRow.length && $origDtRow.find('.dataTables_length,.dataTables_filter').length === 0) {
                    $origDtRow.remove();
                }
            }

            // ---------------------------
            // CRON PREVIEW (INLINE + BUTTON)
            // ---------------------------
            function setInlinePreviewVisible(show) {
                $("#cron-inline-preview").toggle(!!show);
            }

            function setInlineErrorVisible(show, msg) {
                $("#cron-inline-error").toggle(!!show);
                $("#cron-inline-error").text(msg || "");
            }

            function renderInlineRuns(runs, tz) {
                var ul = $("#cron-inline-runs");
                ul.empty();
                (runs || []).forEach(function (iso) {
                    ul.append("<li>" + escapeHtml(fmtDate(iso)) + "</li>");
                });
                $("#cron-inline-tz").text(tz ? ("(" + tz + ")") : "");
            }

            function previewCron(cronExpr, count) {
                cronExpr = (cronExpr || "").trim();
                if (!cronExpr) {
                    setInlinePreviewVisible(false);
                    setInlineErrorVisible(false);
                    return Promise.resolve(null);
                }

                setInlineErrorVisible(false);

                return fetch(URL_PREVIEW, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                    body: JSON.stringify({cron_expression: cronExpr, count: count || 5})
                }).then(function (r) {
                    if (!r.ok) {
                        return r.json().catch(function () {
                            return {};
                        }).then(function (j) {
                            var msg = "Invalid cron expression";
                            if (j && j.cron_expression && Array.isArray(j.cron_expression) && j.cron_expression.length) {
                                msg = j.cron_expression[0];
                            } else if (j && typeof j.detail === "string") {
                                msg = j.detail;
                            }
                            throw new Error(msg);
                        });
                    }
                    return r.json();
                }).then(function (resp) {
                    var runs = resp && resp.runs ? resp.runs : [];
                    setInlinePreviewVisible(true);
                    renderInlineRuns(runs, resp && resp.timezone ? resp.timezone : "");
                    return resp;
                }).catch(function (err) {
                    setInlinePreviewVisible(false);
                    setInlineErrorVisible(true, err && err.message ? err.message : "Invalid cron expression");
                    return null;
                });
            }

            var previewTimer = null;

            function scheduleDebouncedPreview() {
                if (previewTimer) clearTimeout(previewTimer);
                previewTimer = setTimeout(function () {
                    previewCron($("#form-cron").val(), 5);
                }, 400);
            }

            // Preset -> fill cron input and preview
            $("#form-cron-preset").on("change", function () {
                var v = $(this).val() || "";
                if (v) {
                    $("#form-cron").val(v);
                    scheduleDebouncedPreview();
                }
            });

            // Typing in cron -> debounce preview
            $("#form-cron").on("input", function () {
                scheduleDebouncedPreview();
            });

            // ---------------------------
            // SCHEDULES TABLE
            // ---------------------------
            // Important: DataTables injects the length/search controls asynchronously
            // relative to our DOM manipulations in some setups. Move the controls in
            // initComplete to make sure they exist.
            var schedulesById = {};
            var schedulesTable = $("#tbl-schedules").DataTable({
                paging: true,
                searching: true,
                order: [[5, "asc"]],  // default: sort by Next tick (if backend provides it)
                initComplete: function () {
                    moveDataTablesControls(this.api(), $("#schedules-filters"));
                }
            });

            function loadSchedules() {
                var orgId = $("#filter-org").val();
                var projectId = $("#filter-project").val();
                var enabled = $("#filter-enabled").val();

                var url = URL_SCHEDULES_LIST + "?";
                if (orgId) url += "organization_id=" + encodeURIComponent(orgId) + "&";
                if (projectId) url += "project_id=" + encodeURIComponent(projectId) + "&";
                if (enabled !== "") url += "enabled=" + encodeURIComponent(enabled) + "&";

                fetch(url, {credentials: "same-origin"})
                    .then(function (r) {
                        return r.json();
                    })
                    .then(function (data) {
                        var items = parseListResponse(data);
                        schedulesTable.clear();
                        schedulesById = {};

                        items.forEach(function (s) {
                            schedulesById[String(s.id)] = s;
                            // Prefer backend-provided names. If absent, do not render blank.
                            var projectName = s.project_name || (s.project_id ? String(s.project_id) : "—");
                            var launchConfigLabel = s.launch_config_name || (s.launch_config_id ? ("#" + s.launch_config_id) : "—");

                            // Backend SSOT fields (preferred)
                            var dueNow = (typeof s.due_now === "boolean") ? s.due_now : false;

                            var dueTickDisplay = s.due_tick_human || fmtDate(s.due_tick) || "";
                            var nextTickDisplay = s.next_tick_human || fmtDate(s.next_tick) || "";

                            if (!s.next_tick && !s.next_tick_human && s.enabled) {
                                nextTickDisplay = '<span class="text-danger">Invalid cron</span>';
                            }

                            var actions = '';
                            actions += '<button class="btn btn-xs btn-default act-toggle" data-id="' + s.id + '" data-enabled="' + (s.enabled ? "1" : "0") + '">' + (s.enabled ? 'Disable' : 'Enable') + '</button> ';
                            actions += '<button class="btn btn-xs btn-info act-run-once" data-id="' + s.id + '">Run once</button>';
                            actions += ' <button class="btn btn-xs btn-danger act-delete" data-id="' + s.id + '">Delete</button>';

                            schedulesTable.row.add([
                                escapeHtml(projectName),
                                escapeHtml(launchConfigLabel),
                                escapeHtml(s.cron_expression || ""),
                                statusBadge(!!s.enabled, dueNow),
                                dueTickDisplay,
                                nextTickDisplay,
                                actions
                            ]);
                        });

                        schedulesTable.draw();
                    })
                    .catch(function (err) {
                        console.error("Failed to load schedules", err);
                    });
            }

            $("#btn-refresh-schedules").on("click", loadSchedules);
            $("#filter-org, #filter-project, #filter-enabled").on("change", loadSchedules);

            $("#tbl-schedules tbody").on("click", "button.act-toggle", function () {
    var scheduleId = $(this).data("id");
    var s = schedulesById[String(scheduleId)];

    if (!s) {
        alert("Failed to toggle schedule: schedule is not loaded. Refresh the table.");
        return;
    }
    if (!s.project_id) {
        alert("Failed to toggle schedule: schedule has no project_id.");
        return;
    }
    if (!s.launch_config_id) {
        alert("Failed to toggle schedule: schedule has no launch_config_id.");
        return;
    }

    var url = URL_SCHEDULE_UPSERT_TPL.replace("{project_id}", String(s.project_id));

    // Use the official SSOT endpoint for schedule writes:
    // POST /projects/<project_id>/launch-schedule/
    var payload = {
        cron_expression: String(s.cron_expression || "").trim(),
        enabled: !Boolean(s.enabled),
        max_concurrent_per_worker: parseInt(s.max_concurrent_per_worker, 10),
        launch_config_id: parseInt(s.launch_config_id, 10)
    };

    fetch(url, {
        method: "POST",
        credentials: "same-origin",
        headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
        body: JSON.stringify(payload)
    }).then(function (r) {
        if (r.ok) return r.json().catch(function () { return {}; });

        return r.text().then(function (t) {
            var msg = t || ("HTTP " + r.status);
            try {
                var j = JSON.parse(t);
                if (j && typeof j.detail === "string") msg = j.detail;
                else if (j && typeof j === "object") {
                    var k = Object.keys(j)[0];
                    if (k && Array.isArray(j[k]) && j[k].length) msg = j[k][0];
                }
            } catch (e) { /* ignore */ }
            throw new Error(msg);
        });
    }).then(function () {
        loadSchedules();
    }).catch(function (err) {
        alert("Failed to toggle schedule: " + (err && err.message ? err.message : String(err)));
    });
});


            $("#tbl-schedules tbody").on("click", "button.act-run-once", function () {
                var scheduleId = $(this).data("id");
                if (!scheduleId) return;

                var url = URL_SCHEDULE_RUN_ONCE_TPL.replace("{launch_schedule_id}", String(scheduleId));

                fetch(url, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                    body: JSON.stringify({})
                }).then(function (r) {
                    if (!r.ok) return r.text().then(function (t) {
                        throw new Error(t || "Run once failed");
                    });
                    return r.json().catch(function () {
                        return {};
                    });
                }).then(function () {
                    // refresh both panels to show immediate effect
                    loadQueue();
                    loadSchedules();
                }).catch(function (err) {
                    alert("Run once failed: " + err);
                });
            });

            $("#tbl-schedules tbody").on("click", "button.act-delete", function () {
                var scheduleId = $(this).data("id");
                if (!scheduleId) return;
                var s = schedulesById[String(scheduleId)];
                var label = s ? (s.project_name || ("#" + s.project_id)) : ("#" + scheduleId);
                if (!confirm("Delete schedule for " + label + "?")) return;

                var url = URL_SCHEDULE_DELETE_TPL.replace("{launch_schedule_id}", String(scheduleId));
                fetch(url, {
                    method: "DELETE",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                }).then(function (r) {
                    if (!r.ok) return r.text().then(function (t) {
                        throw new Error(t || "Delete failed");
                    });
                }).then(function () {
                    loadSchedules();
                    showToast("Schedule deleted.", "success");
                }).catch(function (err) {
                    showToast("Delete failed: " + err, "danger");
                });
            });

            // Bulk disable
            $("#btn-bulk-disable-org").on("click", function () {
                var orgId = $("#filter-org").val();
                if (!orgId) return alert("Select organization first");
                fetch(URL_BULK_DISABLE, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                    body: JSON.stringify({organization_id: parseInt(orgId, 10)})
                }).then(function (r) {
                    return r.json();
                })
                    .then(function () {
                        loadSchedules();
                    })
                    .catch(function (err) {
                        alert("Bulk disable failed: " + err);
                    });
            });

            $("#btn-bulk-disable-project").on("click", function () {
                var projectId = $("#filter-project").val();
                if (!projectId) return alert("Select project first");
                fetch(URL_BULK_DISABLE, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                    body: JSON.stringify({project_id: parseInt(projectId, 10)})
                }).then(function (r) {
                    return r.json();
                })
                    .then(function () {
                        loadSchedules();
                    })
                    .catch(function (err) {
                        alert("Bulk disable failed: " + err);
                    });
            });

            // ---------------------------
            // QUEUE TABLE
            // ---------------------------
            // Same rationale as schedules table: move DataTables controls in initComplete.
            var queueTable = $("#tbl-queue").DataTable({
                paging: true,
                searching: true,
                order: [[0, "desc"]],
                initComplete: function () {
                    moveDataTablesControls(this.api(), $("#queue-filters"));
                }
            });
            var queueById = {};

            function queueStatusBadge(dispatched) {
                if (dispatched) return '<span class="label label-info">Dispatched</span>';
                return '<span class="label label-warning">Pending</span>';
            }

            function loadQueue() {
                var onlyPending = $("#queue-only-pending").is(":checked");
                var url = URL_QUEUE + "?limit=500";
                if (onlyPending) url += "&only_pending=true";

                fetch(url, {credentials: "same-origin"})
                    .then(function (r) {
                        return r.json();
                    })
                    .then(function (data) {
                        var items = parseListResponse(data);
                        queueTable.clear();
                        queueById = {};

                        items.forEach(function (q) {
                            queueById[String(q.id)] = q;
                            var pipelineLink = q.pipeline_id
                                ? ('<a href="' + URL_PIPELINE_DETAIL_TPL.replace("{pipeline_id}", q.pipeline_id) + '">' + q.pipeline_id + "</a>")
                                : "";
                            var deleteBtn = '<button class="btn btn-xs btn-danger act-queue-delete" data-id="' + q.id + '">Delete</button>';
                            queueTable.row.add([
                                fmtDate(q.created),
                                escapeHtml(q.project_name || (q.project_id ? String(q.project_id) : "")),
                                q.schedule_id || "",
                                q.launch_config_id || "",
                                queueStatusBadge(!!q.dispatched),
                                pipelineLink,
                                fmtAge(q.age_seconds),
                                deleteBtn
                            ]);
                        });

                        queueTable.draw();
                    })
                    .catch(function (err) {
                        console.error("Failed to load queue", err);
                    });
            }

            $("#btn-refresh-queue").on("click", loadQueue);
            $("#queue-only-pending").on("change", loadQueue);

            $("#tbl-queue tbody").on("click", "button.act-queue-delete", function () {
                var queueId = $(this).data("id");
                if (!queueId) return;
                var q = queueById[String(queueId)];
                var label = q ? (q.project_name || ("#" + q.project_id)) : ("#" + queueId);
                if (!confirm("Delete queue item for " + label + "?")) return;

                var url = URL_QUEUE_DELETE_TPL.replace("{queue_id}", String(queueId));
                fetch(url, {
                    method: "DELETE",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                }).then(function (r) {
                    if (!r.ok) return r.text().then(function (t) {
                        throw new Error(t || "Delete failed");
                    });
                }).then(function () {
                    loadQueue();
                    showToast("Queue item deleted.", "success");
                }).catch(function (err) {
                    showToast("Delete failed: " + err, "danger");
                });
            });

            // ---------------------------
            // LAUNCH CONFIGS TABLE
            // ---------------------------
            var launchConfigsById = {};
            var collapsedLaunchConfigGroups = {};
            var expandedLaunchConfigIds = {};
            var launchConfigsTable = $("#tbl-launch-configs").DataTable({
                paging: true,
                searching: true,
                order: [[1, "asc"], [4, "desc"]],
                columnDefs: [
                    {orderable: false, searchable: false, targets: [0, 7]}
                ],
                initComplete: function () {
                    moveDataTablesControls(this.api(), $("#launch-configs-filters"));
                },
                drawCallback: function () {
                    var api = this.api();
                    var rows = api.rows({page: "current"}).nodes();
                    var last = null;

                    $("#tbl-launch-configs tbody tr.group").remove();

                    api.column(1, {page: "current"}).data().each(function (group, i) {
                        if (last !== group) {
                            var isCollapsed = !!collapsedLaunchConfigGroups[group];
                            var marker = isCollapsed ? "+" : "–";
                            $(rows).eq(i).before(
                                '<tr class="group" data-group="' + group + '"><td colspan="8">' + marker + " " + group + "</td></tr>"
                            );
                            last = group;
                        }

                        if (collapsedLaunchConfigGroups[group]) {
                            $(rows).eq(i).hide();
                        } else {
                            $(rows).eq(i).show();
                        }
                    });
                }
            });

            function prettyActionType(v) {
                return String(v || "")
                    .toLowerCase()
                    .replace(/_/g, " ");
            }

            function formatActionSummary(actions) {
                if (!actions || actions.length === 0) return '<span class="text-muted">None</span>';
                var counts = {};
                actions.forEach(function (a) {
                    var k = a.action_type || "unknown";
                    counts[k] = (counts[k] || 0) + 1;
                });
                var parts = [];
                Object.keys(counts).forEach(function (k) {
                    parts.push(prettyActionType(k) + " ×" + counts[k]);
                });
                return escapeHtml(parts.join(", "));
            }

            function formatLaunchConfigDetails(item) {
                var paramsJson = escapeHtml(JSON.stringify(item.params || {}, null, 2));
                var actions = item.actions || [];
                var actionsHtml = "";
                if (!actions.length) {
                    actionsHtml = '<div class="text-muted small">No actions</div>';
                } else {
                    actionsHtml += '<table class="table table-condensed table-bordered" style="margin-bottom:0;">';
                    actionsHtml += '<thead><tr><th>Trigger</th><th>Type</th><th>Config</th></tr></thead><tbody>';
                    actions.forEach(function (a) {
                        var cfg = escapeHtml(JSON.stringify(a.config || {}, null, 2));
                        actionsHtml += "<tr>" +
                            "<td>" + escapeHtml(a.trigger_status || "") + "</td>" +
                            "<td>" + escapeHtml(prettyActionType(a.action_type || "")) + "</td>" +
                            "<td><pre class=\"small\">" + cfg + "</pre></td>" +
                            "</tr>";
                    });
                    actionsHtml += "</tbody></table>";
                }

                return (
                    '<div class="launch-config-details">' +
                    '<div class="launch-config-details__col">' +
                    '<div class="text-muted small">Params</div>' +
                    '<pre class="small">' + paramsJson + "</pre>" +
                    "</div>" +
                    '<div class="launch-config-details__col">' +
                    '<div class="text-muted small">Actions</div>' +
                    actionsHtml +
                    "</div>" +
                    "</div>"
                );
            }

            function loadLaunchConfigs() {
                expandedLaunchConfigIds = {};
                $("#tbl-launch-configs tbody tr.shown span.details-control").each(function () {
                    var id = $(this).data("id");
                    if (id != null) expandedLaunchConfigIds[String(id)] = true;
                });

                var orgId = $("#filter-lc-org").val();
                var projectId = $("#filter-lc-project").val();
                var isDefault = $("#filter-lc-default").val();

                var url = URL_LAUNCH_CONFIGS_DASHBOARD + "?";
                if (orgId) url += "organization_id=" + encodeURIComponent(orgId) + "&";
                if (projectId) url += "project_id=" + encodeURIComponent(projectId) + "&";
                if (isDefault !== "") url += "is_default=" + encodeURIComponent(isDefault) + "&";

                fetch(url, {credentials: "same-origin"})
                    .then(function (r) {
                        return r.json();
                    })
                    .then(function (data) {
                        var items = parseListResponse(data);
                        launchConfigsTable.clear();
                        launchConfigsById = {};

                        items.forEach(function (cfg) {
                            launchConfigsById[String(cfg.id)] = cfg;
                            var projectLabel = cfg.project_name || (cfg.project ? String(cfg.project) : "—");
                            if (cfg.organization_name) {
                                projectLabel += " — " + cfg.organization_name;
                            }
                            if (cfg.project) {
                                projectLabel += " (#" + cfg.project + ")";
                            }
                            var cfgLabel = cfg.name || ("#" + cfg.id);
                            var defLabel = cfg.is_default ? '<span class="label label-success">Default</span>' : "";
                            var actionsSummary = formatActionSummary(cfg.actions || []);
                            var manage = '<button class="btn btn-xs btn-danger act-lc-delete" data-project-id="' + cfg.project + '" data-id="' + cfg.id + '">Delete</button>';

                            launchConfigsTable.row.add([
                                '<span class="details-control" data-id="' + cfg.id + '">+</span>',
                                escapeHtml(projectLabel),
                                escapeHtml(cfgLabel),
                                defLabel,
                                escapeHtml(fmtDate(cfg.updated)),
                                actionsSummary,
                                escapeHtml(cfg.description || ""),
                                manage
                            ]);
                        });

                        launchConfigsTable.draw();

                        Object.keys(expandedLaunchConfigIds).forEach(function (id) {
                            var item = launchConfigsById[String(id)];
                            if (!item) return;
                            var group = item.project_name || (item.project ? String(item.project) : "");
                            if (item.organization_name) {
                                group += " — " + item.organization_name;
                            }
                            if (item.project) {
                                group += " (#" + item.project + ")";
                            }
                            if (group) {
                                collapsedLaunchConfigGroups[group] = false;
                            }
                        });
                        launchConfigsTable.draw(false);

                        $("#tbl-launch-configs tbody span.details-control").each(function () {
                            var $ctrl = $(this);
                            var id = $ctrl.data("id");
                            if (!expandedLaunchConfigIds[String(id)]) return;
                            var $row = $ctrl.closest("tr");
                            var row = launchConfigsTable.row($row);
                            if (row.child && row.child.isShown()) return;
                            var item = launchConfigsById[String(id)];
                            row.child(formatLaunchConfigDetails(item || {})).show();
                            $row.addClass("shown");
                            $ctrl.text("–");
                        });
                    })
                    .catch(function (err) {
                        console.error("Failed to load launch configs", err);
                    });
            }

            $("#btn-refresh-launch-configs").on("click", loadLaunchConfigs);
            $("#filter-lc-org, #filter-lc-project, #filter-lc-default").on("change", loadLaunchConfigs);

            $("#tbl-launch-configs tbody").on("click", "td.details-control, span.details-control", function () {
                var $row = $(this).closest("tr");
                var row = launchConfigsTable.row($row);

                if (row.child.isShown()) {
                    row.child.hide();
                    $row.removeClass("shown");
                    $row.find("span.details-control").text("+");
                    var closedId = $row.find("span.details-control").data("id");
                    if (closedId != null) delete expandedLaunchConfigIds[String(closedId)];
                    return;
                }

                var cfgId = $row.find("span.details-control").data("id");
                if (cfgId != null) expandedLaunchConfigIds[String(cfgId)] = true;
                var item = launchConfigsById[String(cfgId)];
                row.child(formatLaunchConfigDetails(item || {})).show();
                $row.addClass("shown");
                $row.find("span.details-control").text("–");
            });

            $("#tbl-launch-configs tbody").on("click", "tr.group", function () {
                var group = $(this).data("group");
                if (!group) return;
                collapsedLaunchConfigGroups[group] = !collapsedLaunchConfigGroups[group];
                launchConfigsTable.rows().every(function () {
                    if (this.child && this.child.isShown()) {
                        this.child.hide();
                    }
                });
                launchConfigsTable.draw(false);
            });

            $("#tbl-launch-configs tbody").on("click", "button.act-lc-delete", function () {
                var configId = $(this).data("id");
                var projectId = $(this).data("project-id");
                if (!configId || !projectId) return;
                var cfg = launchConfigsById[String(configId)];
                var label = cfg ? (cfg.name || ("#" + configId)) : ("#" + configId);
                if (!confirm("Delete launch config " + label + "?")) return;

                var url = URL_LAUNCH_CONFIG_DELETE_TPL
                    .replace("{project_id}", String(projectId))
                    .replace("{config_id}", String(configId));
                fetch(url, {
                    method: "DELETE",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                }).then(function (r) {
                    if (!r.ok) return r.text().then(function (t) {
                        throw new Error(t || "Delete failed");
                    });
                }).then(function () {
                    loadLaunchConfigs();
                    showToast("Launch config deleted.", "success");
                }).catch(function (err) {
                    showToast("Delete failed: " + err, "danger");
                });
            });

            function startAutoRefresh() {
                if (autoRefreshTimer) return;
                autoRefreshTimer = window.setInterval(function () {
                    loadSchedules();
                    loadQueue();
                    if ($("#tab-launch-configs").hasClass("active")) {
                        loadLaunchConfigs();
                    }
                }, AUTO_REFRESH_MS);
            }

            function stopAutoRefresh() {
                if (!autoRefreshTimer) return;
                window.clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }

            $("#btn-clear-dispatched").on("click", function () {
                var days = parseInt($("#clear-days").val() || "14", 10);
                if (!(days >= 1 && days <= 365)) return alert("Days must be between 1 and 365");

                fetch(URL_QUEUE_CLEAR, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                    body: JSON.stringify({days: days})
                }).then(function (r) {
                    return r.json();
                })
                    .then(function (resp) {
                        alert("Deleted: " + (resp.deleted || 0));
                        loadQueue();
                    })
                    .catch(function (err) {
                        alert("Clear failed: " + err);
                    });
            });

            // ---------------------------
            // CREATE / UPDATE + PREVIEW
            // ---------------------------
            function resetCreateForm() {
                $("#form-project").val("");
                $("#form-launch-config").empty()
                    .append('<option value="">' + TXT_SELECT_PROJECT_FIRST + "</option>")
                    .prop("disabled", true);
                $("#form-cron-preset").val("");
                $("#form-cron").val("");
                $("#form-enabled").val("1");
                $("#form-max-conc").val("1");
                $("#cron-inline-preview").hide();
                $("#cron-inline-error").hide().text("");

                if (typeof ensureSelectPicker === "function") {
                    ensureSelectPicker($("#form-project"));
                    ensureSelectPicker($("#form-launch-config"));
                }
            }

            function switchToSchedulesTab() {
                var schedulesTab = document.querySelector('a[data-toggle="tab"][href="#tab-schedules"]');
                if (!schedulesTab) {
                    return;
                }

                if (window.bootstrap && window.bootstrap.Tab) {
                    var tab = window.bootstrap.Tab.getOrCreateInstance(schedulesTab);
                    tab.show();
                } else if (window.jQuery && window.jQuery.fn && window.jQuery.fn.tab) {
                    window.jQuery(schedulesTab).tab("show");
                } else {
                    schedulesTab.parentElement?.classList.add("active");
                    document.getElementById("tab-schedules")?.classList.add("in", "active");
                    document.getElementById("tab-create")?.classList.remove("in", "active");
                }
            }

            $("#btn-save-schedule").on("click", function () {
                var projectId = ($("#form-project").val() || "").trim();
                var launchConfigId = ($("#form-launch-config").val() || "").trim();
                var cron = ($("#form-cron").val() || "").trim();
                var enabled = ($("#form-enabled").val() || "1") === "1";
                var maxConc = parseInt($("#form-max-conc").val() || "1", 10);

                if (!projectId) return alert("Project is required");
                if (!launchConfigId) return alert("Launch config is required");
                if (!cron) return alert("Cron expression is required");
                if (!Number.isFinite(maxConc)) return alert("Max concurrent must be a number");
                if (maxConc < 1) return alert("Max concurrent must be >= 1");

                var url = URL_SCHEDULE_UPSERT_TPL.replace("{project_id}", projectId);
                fetch(url, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: Object.assign({"Content-Type": "application/json"}, csrfHeaders()),
                    body: JSON.stringify({
                        launch_config_id: parseInt(launchConfigId, 10),
                        cron_expression: cron,
                        enabled: enabled,
                        max_concurrent_per_worker: maxConc
                    })
                }).then(function (r) {
                    if (!r.ok) return r.text().then(function (t) {
                        throw new Error(t || "Save failed");
                    });
                    return r.json().catch(function () {
                        return {};
                    });
                }).then(function () {
                    alert("Schedule saved");
                    resetCreateForm();
                    switchToSchedulesTab();
                    loadSchedules();
                    loadQueue();
                }).catch(function (err) {
                    alert("Save failed: " + err);
                });
            });

            $('a[data-toggle="tab"][href="#tab-create"]').on("shown.bs.tab", function () {
                ensureSelectPicker($("#form-project"));
                ensureSelectPicker($("#form-launch-config"));
            });

            // initial load
            loadSchedules();
            loadQueue();

            var AUTO_REFRESH_MS = 15000;
            var autoRefreshTimer = null;

            startAutoRefresh();

            document.addEventListener("visibilitychange", function () {
                if (document.hidden) {
                    stopAutoRefresh();
                } else {
                    loadSchedules();
                    loadQueue();
                    if ($("#tab-launch-configs").hasClass("active")) {
                        loadLaunchConfigs();
                    }
                    startAutoRefresh();
                }
            });

            $('a[data-toggle="tab"][href="#tab-launch-configs"]').on("shown.bs.tab", function () {
                loadLaunchConfigs();
            });
        })();
    </script>
{% endblock %}

{% extends "base.html" %}

{% block breadcrumbs %}
    <li class="breadcrumb-item active" aria-current="page">
        AIST Projects
    </li>
{% endblock %}

{% block content %}
    <h2 class="mb-2">AIST Projects</h2>
    <p class="text-muted">
        Manage AIST projects used by SAST pipelines. Only editable fields are exposed.
    </p>

    <div id="aist-projects-alert" class="alert alert-success" style="display:none;"></div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <div class="row">
                <div class="col-sm-6">
                    <strong>Projects by organization</strong>
                </div>
                <div class="col-sm-6">
                    <div class="input-group input-group-sm pull-right" style="max-width: 420px;">
                <span class="input-group-btn">
                    <button type="button"
                            class="btn btn-default"
                            id="gitlab-import-open">
                        <i class="fa-brands fa-gitlab" aria-hidden="true"></i>
                        Import from GitLab
                    </button>
                </span>
                        <span class="input-group-addon">
                    <i class="fa fa-search" aria-hidden="true"></i>
                </span>
                        <input id="aist-projects-filter"
                               type="text"
                               class="form-control"
                               placeholder="Filter by product name or project id...">
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="aist-projects-table">
                <thead>
                <tr>
                    <th style="width: 40px;">ID</th>
                    <th>Product</th>
                    <th style="width: 120px;">Pipelines</th>
                    <th>Script path</th>
                    <th>Supported languages</th>
                    <th>Profile</th>
                    <th style="width: 90px;">Compilable</th>
                    <th style="width: 80px;">Edit</th>
                </tr>
                </thead>
                <tbody>
                {# Legacy flat list (kept for compatibility if `projects` is present) #}
                {% for p in projects %}
                    <tr data-project-id="{{ p.id }}"
                        data-project-name="{{ p.product.name|default_if_none:'' }}"
                        data-project-script-path="{{ p.script_path|default_if_none:'' }}"
                        data-project-compilable="{{ p.compilable|yesno:'true,false' }}"
                        data-project-langs="{{ p.supported_languages|join:', ' }}"
                        data-project-profile="{{ p.profile|default:'{}'|escapejs }}"
                        data-project-org-id="{{ p.organization_id|default_if_none:'' }}"
                        data-project-org-name="{{ p.organization.name|default_if_none:'' }}"
                        data-update-url="{% url 'dojo_aist:aist_project_update' p.id %}"
                        data-delete-url="{% url 'dojo_aist_api:project_detail' project_id=p.id %}">
                        <td>{{ p.id }}</td>
                        <td>
                            <a href="{% url 'product_open_findings' product_id=p.product.id %}">
                                {{ p.product.name }}
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'dojo_aist:pipeline_list' %}?project={{ p.id }}"
                               class="btn btn-xs btn-default">
                                Pipelines
                            </a>
                        </td>
                        <td class="script-path-cell">
                            <code>{{ p.script_path }}</code>
                        </td>
                        <td class="langs-cell">
                            {% if p.supported_languages %}
                                {{ p.supported_languages|join:", " }}
                            {% else %}
                                <span class="text-muted">–</span>
                            {% endif %}
                        </td>
                        <td class="profile-cell">
                            {% if p.profile %}
                                <code>{{ p.profile|truncatechars:80 }}</code>
                            {% else %}
                                <span class="text-muted">–</span>
                            {% endif %}
                        </td>
                        <td class="compilable-cell">
                            {% if p.compilable %}
                                <span class="label label-success">Yes</span>
                            {% else %}
                                <span class="label label-default">No</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button"
                                    class="btn btn-xs btn-default aist-project-edit-btn">
                                <i class="fa fa-pencil"></i> Edit
                            </button>
                        </td>
                    </tr>
                {% empty %}
                    {# When `projects` is not passed, this block is simply skipped. #}
                {% endfor %}
                </tbody>

                <tbody>
                {% if organizations or unassigned_projects %}
                    {# Organizations and their projects #}
                    {% for org in organizations %}
                        <tr class="active">
                            <td colspan="8">
                                <strong>{{ org.name }}</strong>
                                {% with org.projects.count as cnt %}
                                    <span class="text-muted small">
                                        ({{ cnt }} project{{ cnt|pluralize }})
                                    </span>
                                {% endwith %}
                            </td>
                        </tr>
                        {% for p in org.projects.all %}
                            <tr data-project-id="{{ p.id }}"
                                data-project-name="{{ p.product.name|default_if_none:'' }}"
                                data-project-script-path="{{ p.script_path|default_if_none:'' }}"
                                data-project-compilable="{{ p.compilable|yesno:'true,false' }}"
                                data-project-langs="{{ p.supported_languages|join:', ' }}"
                                data-project-profile="{{ p.profile|default:'{}'|escapejs }}"
                                data-project-org-id="{{ p.organization_id|default_if_none:'' }}"
                                data-project-org-name="{{ org.name|default_if_none:'' }}"
                                data-update-url="{% url 'dojo_aist:aist_project_update' p.id %}"
                                data-delete-url="{% url 'dojo_aist_api:project_detail' project_id=p.id %}">
                                <td>{{ p.id }}</td>
                                <td>
                                    <a href="{% url 'product_open_findings' product_id=p.product.id %}">
                                        {{ p.product.name }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'dojo_aist:pipeline_list' %}?project={{ p.id }}"
                                       class="btn btn-xs btn-default">
                                        Pipelines
                                    </a>
                                </td>
                                <td class="script-path-cell">
                                    {% if p.script_path %}
                                        <code>{{ p.script_path }}</code>
                                    {% else %}
                                        <span class="text-muted">–</span>
                                    {% endif %}
                                </td>
                                <td class="langs-cell">
                                    {% if p.supported_languages %}
                                        {{ p.supported_languages|join:", " }}
                                    {% else %}
                                        <span class="text-muted">–</span>
                                    {% endif %}
                                </td>
                                <td class="profile-cell">
                                    {% if p.profile %}
                                        <code>{{ p.profile|truncatechars:80 }}</code>
                                    {% else %}
                                        <span class="text-muted">–</span>
                                    {% endif %}
                                </td>
                                <td class="compilable-cell">
                                    {% if p.compilable %}
                                        <span class="label label-success">Yes</span>
                                    {% else %}
                                        <span class="label label-default">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button"
                                            class="btn btn-xs btn-default aist-project-edit-btn">
                                        <i class="fa fa-pencil"></i> Edit
                                    </button>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="8" class="text-muted small">
                                    No projects in this organization.
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}

                    {# Projects without organization -> Others group #}
                    {% if unassigned_projects %}
                        <tr class="active">
                            <td colspan="8">
                                <strong>Others</strong>
                                <span class="text-muted small">
                                    ({{ unassigned_projects|length }} project{{ unassigned_projects|length|pluralize }})
                                </span>
                            </td>
                        </tr>
                        {% for p in unassigned_projects %}
                            <tr data-project-id="{{ p.id }}"
                                data-project-name="{{ p.product.name|default_if_none:'' }}"
                                data-project-script-path="{{ p.script_path|default_if_none:'' }}"
                                data-project-compilable="{{ p.compilable|yesno:'true,false' }}"
                                data-project-langs="{{ p.supported_languages|join:', ' }}"
                                data-project-profile="{{ p.profile|default:'{}'|escapejs }}"
                                data-project-org-id="{{ p.organization_id|default_if_none:'' }}"
                                data-project-org-name=""
                                data-update-url="{% url 'dojo_aist:aist_project_update' p.id %}"
                                data-delete-url="{% url 'dojo_aist_api:project_detail' project_id=p.id %}">
                                <td>{{ p.id }}</td>
                                <td>
                                    <a href="{% url 'product_open_findings' product_id=p.product.id %}">
                                        {{ p.product.name }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'dojo_aist:pipeline_list' %}?project={{ p.id }}"
                                       class="btn btn-xs btn-default">
                                        Pipelines
                                    </a>
                                </td>
                                <td class="script-path-cell">
                                    {% if p.script_path %}
                                        <code>{{ p.script_path }}</code>
                                    {% else %}
                                        <span class="text-muted">–</span>
                                    {% endif %}
                                </td>
                                <td class="langs-cell">
                                    {% if p.supported_languages %}
                                        {{ p.supported_languages|join:", " }}
                                    {% else %}
                                        <span class="text-muted">–</span>
                                    {% endif %}
                                </td>
                                <td class="profile-cell">
                                    {% if p.profile %}
                                        <code>{{ p.profile|truncatechars:80 }}</code>
                                    {% else %}
                                        <span class="text-muted">–</span>
                                    {% endif %}
                                </td>
                                <td class="compilable-cell">
                                    {% if p.compilable %}
                                        <span class="label label-success">Yes</span>
                                    {% else %}
                                        <span class="label label-default">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button"
                                            class="btn btn-xs btn-default aist-project-edit-btn">
                                        <i class="fa fa-pencil"></i> Edit
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-muted text-center">
                            No AIST projects found.
                        </td>
                    </tr>
                {% endif %}
                </tbody>

            </table>
        </div>
    </div>

    {# Modal for importing projects from GitLab #}
    <div class="modal fade" id="gitlabImportModal" tabindex="-1" role="dialog"
         aria-labelledby="gitlabImportModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <form id="gitlab-import-form">
                    {% csrf_token %}
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"
                                aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="gitlabImportModalLabel">
                            Import projects from GitLab
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div id="gitlab-import-error"
                             class="alert alert-danger"
                             style="display:none;"></div>

                        <div class="form-group">
                            <label for="gitlab-url">GitLab URL</label>
                            <input type="url"
                                   class="form-control"
                                   id="gitlab-url"
                                   name="gitlab_url"
                                   placeholder="https://gitlab.example.com"
                                   required>
                            <p class="help-block">
                                Base URL of your GitLab instance (without trailing slash).
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="gitlab-token">GitLab personal access token</label>
                            <div class="input-group">
                                <input type="password"
                                       class="form-control"
                                       id="gitlab-token"
                                       name="gitlab_token"
                                       autocomplete="off"
                                       required>

                                <button class="btn btn-default"
                                        type="button"
                                        id="gitlab-token-toggle">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                            <p class="help-block">
                                Token is used only for this import operation and is not stored.
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="gitlab-org-select">Organization (optional)</label>
                            <select class="form-control" id="gitlab-org-select" name="organization_id">
                                <option value="">None</option>
                                {% for org in organizations %}
                                    <option value="{{ org.id }}">{{ org.name }}</option>
                                {% endfor %}
                            </select>
                            <p class="help-block">
                                If selected, all imported projects will be attached to this organization.
                            </p>
                        </div>

                        <hr>

                        <div id="gitlab-projects-container" style="display:none;">
                            <p class="text-muted small">
                                Select one or more projects to import as AIST projects.
                            </p>
                            <div class="form-group">
                                <input type="text"
                                       class="form-control input-sm"
                                       id="gitlab-projects-search"
                                       placeholder="Filter projects by name, path or description...">
                            </div>
                            <div class="table-responsive" style="max-height: 320px; overflow-y: auto;">
                                <table class="table table-condensed table-hover" id="gitlab-projects-table">
                                    <thead>
                                    <tr>
                                        <th style="width: 30px;">
                                            <input type="checkbox" id="gitlab-select-all">
                                        </th>
                                        <th style="width: 80px;">ID</th>
                                        <th>Path</th>
                                        <th style="width: 120px;">Language</th>
                                        <th>Description</th>
                                        <th style="width: 120px;">Default branch</th>
                                    </tr>
                                    </thead>
                                    <tbody id="gitlab-projects-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-default"
                                data-dismiss="modal">
                            Close
                        </button>
                        <button type="button"
                                class="btn btn-primary"
                                id="gitlab-list-btn">
                            List projects
                        </button>

                        <span id="gitlab-projects-loading"
                              class="text-muted"
                              style="display: none; margin-left: 8px;">
                            <i class="fa fa-spinner fa-spin"></i> Loading projects...
                        </span>
                        <button type="button"
                                class="btn btn-success"
                                id="gitlab-import-btn"
                                disabled>
                            Import selected
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# Modal for editing a single project #}
    <div class="modal fade" id="aistProjectModal" tabindex="-1" role="dialog"
         aria-labelledby="aistProjectModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="aist-project-edit-form">
                    {% csrf_token %}
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"
                                aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="aistProjectModalLabel">
                            Edit AIST Project
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div id="aist-project-edit-error"
                             class="alert alert-danger"
                             style="display:none;"></div>

                        <div class="form-group">
                            <label>Project ID</label>
                            <input type="text" class="form-control" id="ap-project-id"
                                   readonly>
                        </div>

                        <div class="form-group">
                            <label>Product</label>
                            <input type="text" class="form-control" id="ap-product-name"
                                   readonly>
                        </div>

                        <div class="form-group">
                            <label>Organization</label>
                            <select class="form-control"
                                    id="ap-organization"
                                    name="organization">
                                <option value="">No organization</option>
                                {% for org in organizations %}
                                    <option value="{{ org.id }}">{{ org.name }}</option>
                                {% endfor %}
                            </select>
                            <p class="help-block">
                                Optional organization used to group projects.
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="ap-script-path">Script path</label>
                            <input type="text"
                                   class="form-control"
                                   id="ap-script-path"
                                   name="script_path"
                                   required>
                            <p class="help-block">
                                Relative path to the build / analysis script inside the project.
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="ap-supported-languages">Supported languages</label>
                            <input type="text"
                                   class="form-control"
                                   id="ap-supported-languages"
                                   name="supported_languages">
                            <p class="help-block">
                                Comma-separated list, e.g. <code>python, cpp, java</code>.
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="ap-profile">Profile (JSON)</label>
                            <textarea
                                    class="form-control"
                                    id="ap-profile"
                                    name="profile"
                                    rows="8"
                                    style="font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 12px;"></textarea>
                            <p class="help-block">
                                JSON object, for example:
                                <code>{"paths": {"exclude": ["artifacts", "test"]}}</code>.
                            </p>
                        </div>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox"
                                       id="ap-compilable"
                                       name="compilable">
                                Project is compilable
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-danger pull-left"
                                id="aist-project-delete-btn">
                            Delete
                        </button>
                        <button type="button"
                                class="btn btn-default"
                                data-dismiss="modal">Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Save changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function () {
            "use strict";

            var table = document.getElementById("aist-projects-table");
            var filterInput = document.getElementById("aist-projects-filter");
            var modal = document.getElementById("aistProjectModal");
            var form = document.getElementById("aist-project-edit-form");
            var errorBox = document.getElementById("aist-project-edit-error");
            var globalAlert = document.getElementById("aist-projects-alert");

            var fieldId = document.getElementById("ap-project-id");
            var fieldProduct = document.getElementById("ap-product-name");
            var fieldOrganization = document.getElementById("ap-organization");
            var fieldScriptPath = document.getElementById("ap-script-path");
            var fieldLangs = document.getElementById("ap-supported-languages");
            var fieldCompilable = document.getElementById("ap-compilable");
            var fieldProfile = document.getElementById("ap-profile");
            var deleteBtn = document.getElementById("aist-project-delete-btn");

            // GitLab import modal elements
            var gitlabOpenBtn = document.getElementById("gitlab-import-open");
            var gitlabModal = document.getElementById("gitlabImportModal");
            var gitlabForm = document.getElementById("gitlab-import-form");
            var gitlabErrorBox = document.getElementById("gitlab-import-error");
            var gitlabListBtn = document.getElementById("gitlab-list-btn");
            var loadingIndicator = document.getElementById("gitlab-projects-loading");
            var gitlabImportBtn = document.getElementById("gitlab-import-btn");
            var gitlabProjectsContainer = document.getElementById("gitlab-projects-container");
            var gitlabProjectsTbody = document.getElementById("gitlab-projects-tbody");
            var gitlabSelectAll = document.getElementById("gitlab-select-all");
            var gitlabUrlField = document.getElementById("gitlab-url");
            var gitlabTokenField = document.getElementById("gitlab-token");
            var gitlabTokenToggle = document.getElementById("gitlab-token-toggle");

            // URLs for GitLab integration
            var gitlabListUrl = "{% url 'dojo_aist:gitlab_projects_list' %}";
            var gitlabImportUrl = "{% url 'dojo_aist_api:import_project_from_gitlab' %}";


            var currentRow = null;

            function getCsrfToken() {
                // Standard helper for Django CSRF token detection.
                var fromInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                if (fromInput && fromInput.value) return fromInput.value;

                var fromMeta = document.querySelector('meta[name="csrf-token"]');
                if (fromMeta && fromMeta.content) return fromMeta.content;

                var m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
                if (m) return decodeURIComponent(m[1]);

                return "";
            }

            function showGlobalAlert(message, kind) {
                if (!globalAlert) return;
                globalAlert.className = "alert alert-" + (kind || "success");
                globalAlert.textContent = message;
                globalAlert.style.display = "block";
                setTimeout(function () {
                    globalAlert.style.display = "none";
                }, 3000);
            }

            function openEditModal(row) {
                currentRow = row;

                var id = row.getAttribute("data-project-id") || "";
                var name = row.getAttribute("data-project-name") || "";
                var scriptPath = row.getAttribute("data-project-script-path") || "";
                var langs = row.getAttribute("data-project-langs") || "";
                var compilable = row.getAttribute("data-project-compilable") === "true";
                var orgId = row.getAttribute("data-project-org-id") || "";

                var profileRaw = row.getAttribute("data-project-profile") || "";
                var profilePretty = profileRaw;

                // Try to pretty-print profile JSON, handling both new JSON
                // and legacy Python-style representations coming from the template.
                if (profileRaw && typeof profileRaw === "string") {
                    var normalized = profileRaw;

                    // Convert \u0027 sequences produced by escapejs back to quotes.
                    normalized = normalized.replace(/\\u0027/g, "'");

                    // If it still looks like a Python dict (only single quotes),
                    // convert them to double quotes so JSON.parse can understand it.
                    if (normalized.indexOf("'") !== -1 && normalized.indexOf('"') === -1) {
                        normalized = normalized.replace(/'/g, '"');
                    }

                    try {
                        var obj = JSON.parse(normalized);
                        profilePretty = JSON.stringify(obj, null, 2);
                    } catch (e) {
                        // If JSON is still invalid, at least show the normalized string.
                        profilePretty = normalized;
                    }
                }


                fieldId.value = id;
                fieldProduct.value = name;
                fieldScriptPath.value = scriptPath;
                fieldLangs.value = langs;
                fieldCompilable.checked = compilable;

                if (fieldOrganization) {
                    fieldOrganization.value = orgId || "";
                }

                if (fieldProfile) {
                    fieldProfile.value = profilePretty || "";
                }

                if (errorBox) {
                    errorBox.style.display = "none";
                    errorBox.textContent = "";
                }

                if (window.jQuery && window.jQuery.fn.modal) {
                    window.jQuery(modal).modal("show");
                } else if (modal && modal.classList) {
                    modal.classList.add("in");
                    modal.style.display = "block";
                }
            }

            function applyRowUpdate(row, payload) {
                if (!row || !payload) return;

                row.setAttribute("data-project-script-path", payload.script_path || "");
                row.setAttribute("data-project-compilable", payload.compilable ? "true" : "false");
                row.setAttribute("data-project-langs", (payload.supported_languages || []).join(", "));
                row.setAttribute("data-project-profile", JSON.stringify(payload.profile || {}));
                row.setAttribute(
                    "data-project-org-id",
                    payload.organization_id != null ? String(payload.organization_id) : ""
                );
                row.setAttribute(
                    "data-project-org-name",
                    payload.organization_name || ""
                );

                var scriptCell = row.querySelector(".script-path-cell");
                if (scriptCell) {
                    scriptCell.innerHTML = payload.script_path
                        ? "<code>" + payload.script_path + "</code>"
                        : "<span class=\"text-muted\">–</span>";
                }

                var langsCell = row.querySelector(".langs-cell");
                if (langsCell) {
                    if (payload.supported_languages && payload.supported_languages.length) {
                        langsCell.textContent = payload.supported_languages.join(", ");
                    } else {
                        langsCell.innerHTML = "<span class=\"text-muted\">–</span>";
                    }
                }

                var profileCell = row.querySelector(".profile-cell");
                if (profileCell) {
                    var preview = "";
                    if (payload.profile && Object.keys(payload.profile).length) {
                        try {
                            preview = JSON.stringify(payload.profile);
                        } catch (e) {
                            preview = "";
                        }
                    }
                    if (preview) {
                        if (preview.length > 80) {
                            preview = preview.slice(0, 77) + "…";
                        }
                        profileCell.innerHTML = "<code>" + preview + "</code>";
                    } else {
                        profileCell.innerHTML = "<span class=\"text-muted\">–</span>";
                    }
                }

                var compCell = row.querySelector(".compilable-cell");
                if (compCell) {
                    if (payload.compilable) {
                        compCell.innerHTML = "<span class=\"label label-success\">Yes</span>";
                    } else {
                        compCell.innerHTML = "<span class=\"label label-default\">No</span>";
                    }
                }
            }

            function clearGitlabState() {
                if (gitlabErrorBox) {
                    gitlabErrorBox.style.display = "none";
                    gitlabErrorBox.textContent = "";
                }
                if (gitlabProjectsTbody) {
                    gitlabProjectsTbody.innerHTML = "";
                }
                if (gitlabProjectsContainer) {
                    gitlabProjectsContainer.style.display = "none";
                }
                if (gitlabImportBtn) {
                    gitlabImportBtn.disabled = true;
                }
                if (gitlabSelectAll) {
                    gitlabSelectAll.checked = false;
                }
            }

            function updateGitlabImportButtonState() {
                if (!gitlabProjectsTbody || !gitlabImportBtn) return;
                var anyChecked = !!gitlabProjectsTbody.querySelector(
                    "input.gitlab-project-checkbox:checked"
                );
                gitlabImportBtn.disabled = !anyChecked;
            }


            if (table) {
                table.addEventListener("click", function (ev) {
                    var btn = ev.target;
                    if (!btn) return;

                    if (!btn.classList.contains("aist-project-edit-btn")) {
                        // In case the click was on inner <span> etc.
                        btn = btn.closest(".aist-project-edit-btn");
                        if (!btn) return;
                    }

                    var row = btn.closest("tr[data-project-id]");
                    if (!row) return;

                    openEditModal(row);
                });
            }

            if (filterInput && table) {
                filterInput.addEventListener("keyup", function () {
                    var needle = (filterInput.value || "").toLowerCase();
                    var rows = table.querySelectorAll("tbody tr[data-project-id]");
                    Array.prototype.forEach.call(rows, function (r) {
                        var name = (r.getAttribute("data-project-name") || "").toLowerCase();
                        var id = (r.getAttribute("data-project-id") || "").toLowerCase();
                        if (!needle || name.indexOf(needle) !== -1 || id.indexOf(needle) !== -1) {
                            r.style.display = "";
                        } else {
                            r.style.display = "none";
                        }
                    });
                });
            }

            if (form) {
                form.addEventListener("submit", function (ev) {
                    ev.preventDefault();
                    if (!currentRow) return;

                    var updateUrl = currentRow.getAttribute("data-update-url");
                    if (!updateUrl) return;

                    var formData = new FormData(form);

                    var csrf = getCsrfToken();
                    var headers = {
                        "X-Requested-With": "XMLHttpRequest"
                    };
                    if (csrf) {
                        headers["X-CSRFToken"] = csrf;
                    }

                    fetch(updateUrl, {
                        method: "POST",
                        credentials: "same-origin",
                        headers: headers,
                        body: formData
                    }).then(function (resp) {
                        return resp.json().then(function (data) {
                            return {ok: resp.ok, data: data};
                        });
                    }).then(function (result) {
                        if (!result.ok || !result.data.ok) {
                            var msg = "Failed to update project.";
                            if (result.data && result.data.errors) {
                                msg = Object.values(result.data.errors).join(" ");
                            }
                            if (errorBox) {
                                errorBox.textContent = msg;
                                errorBox.style.display = "block";
                            }
                            return;
                        }

                        applyRowUpdate(currentRow, result.data.project);

                        if (window.jQuery && window.jQuery.fn.modal) {
                            window.jQuery(modal).modal("hide");
                        } else if (modal && modal.classList) {
                            modal.classList.remove("in");
                            modal.style.display = "none";
                        }

                        showGlobalAlert("Project has been updated.", "success");
                    }).catch(function () {
                        if (errorBox) {
                            errorBox.textContent = "Unexpected error while saving project.";
                            errorBox.style.display = "block";
                        }
                    });
                });
            }

            if (gitlabOpenBtn && gitlabModal) {
                gitlabOpenBtn.addEventListener("click", function () {
                    clearGitlabState();

                    if (window.jQuery && window.jQuery.fn.modal) {
                        window.jQuery(gitlabModal).modal("show");
                    } else {
                        gitlabModal.classList.add("in");
                        gitlabModal.style.display = "block";
                    }
                });
            }

            // Show / hide GitLab token
            if (gitlabTokenToggle && gitlabTokenField) {
                gitlabTokenToggle.addEventListener("click", function () {
                    if (gitlabTokenField.type === "password") {
                        gitlabTokenField.type = "text";
                        this.innerHTML = '<i class="fa fa-eye-slash"></i>';
                    } else {
                        gitlabTokenField.type = "password";
                        this.innerHTML = '<i class="fa fa-eye"></i>';
                    }
                });
            }

            // Load projects list from GitLab
            if (gitlabListBtn && gitlabForm && gitlabProjectsTbody) {
                gitlabListBtn.addEventListener("click", function () {

                    gitlabListBtn.disabled = true;
                    if (loadingIndicator) {
                        loadingIndicator.style.display = "inline-block";
                    }
                    var csrf = getCsrfToken();
                    var headers = {
                        "X-Requested-With": "XMLHttpRequest"
                    };
                    if (csrf) {
                        headers["X-CSRFToken"] = csrf;
                    }

                    var formData = new FormData(gitlabForm);

                    clearGitlabState();

                    fetch(gitlabListUrl, {
                        method: "POST",
                        credentials: "same-origin",
                        headers: headers,
                        body: formData
                    }).then(function (resp) {
                        return resp.json().then(function (data) {
                            return {ok: resp.ok, data: data};
                        });
                    }).then(function (result) {
                        if (!result.ok || !result.data.ok) {
                            var msg = (result.data && result.data.error) ||
                                "Failed to load projects from GitLab.";
                            if (gitlabErrorBox) {
                                gitlabErrorBox.textContent = msg;
                                gitlabErrorBox.style.display = "block";
                            }
                            return;
                        }

                        var projects = result.data.projects || [];
                        if (!projects.length) {
                            if (gitlabErrorBox) {
                                gitlabErrorBox.textContent = "No projects returned from GitLab.";
                                gitlabErrorBox.style.display = "block";
                            }
                            return;
                        }

                        var rowsHtml = "";
                        projects.forEach(function (p) {
                            rowsHtml +=
                                '<tr>' +
                                '<td><input type="checkbox" class="gitlab-project-checkbox" value="' + (p.id || "") + '"></td>' +
                                '<td class="text-monospace">' + (p.id || "") + '</td>' +
                                '<td>' + (p.path_with_namespace || p.name || "") + '</td>' +
                                '<td>' + (p.language || "–") + '</td>' +
                                '<td>' + (p.description || "") + '</td>' +
                                '<td>' + (p.default_branch || "") + '</td>' +
                                '</tr>';
                        });

                        gitlabProjectsTbody.innerHTML = rowsHtml;
                        if (gitlabProjectsContainer) {
                            gitlabProjectsContainer.style.display = "block";
                        }
                        updateGitlabImportButtonState();
                    }).catch(function () {
                        if (gitlabErrorBox) {
                            gitlabErrorBox.textContent = "Unexpected error while loading GitLab projects.";
                            gitlabErrorBox.style.display = "block";
                        }
                    }).finally(function () {
                        gitlabListBtn.disabled = false;
                        if (loadingIndicator) {
                            loadingIndicator.style.display = "none";
                        }
                    });
                });
            }

            // Select all / selection change
            if (gitlabSelectAll && gitlabProjectsTbody) {
                gitlabSelectAll.addEventListener("change", function () {
                    var checked = gitlabSelectAll.checked;
                    var checkboxes = gitlabProjectsTbody.querySelectorAll("input.gitlab-project-checkbox");
                    Array.prototype.forEach.call(checkboxes, function (cb) {
                        cb.checked = checked;
                    });
                    updateGitlabImportButtonState();
                });

                gitlabProjectsTbody.addEventListener("change", function (ev) {
                    var target = ev.target;
                    if (!target || !target.classList.contains("gitlab-project-checkbox")) {
                        return;
                    }
                    if (!target.checked && gitlabSelectAll) {
                        gitlabSelectAll.checked = false;
                    }
                    updateGitlabImportButtonState();
                });
            }

            // Import selected GitLab projects via existing API
            if (gitlabImportBtn && gitlabProjectsTbody) {
                gitlabImportBtn.addEventListener("click", function () {
                    var checkboxes = gitlabProjectsTbody.querySelectorAll(
                        "input.gitlab-project-checkbox:checked"
                    );
                    if (!checkboxes.length) {
                        return;
                    }

                    var gitlabUrl = gitlabUrlField ? (gitlabUrlField.value || "") : "";
                    var gitlabToken = gitlabTokenField ? (gitlabTokenField.value || "") : "";
                    var organizationField = document.getElementById("gitlab-org-select")
                    const org = organizationField ? (organizationField.value || "") : "";

                    if (!gitlabUrl || !gitlabToken) {
                        if (gitlabErrorBox) {
                            gitlabErrorBox.textContent = "GitLab URL and token are required.";
                            gitlabErrorBox.style.display = "block";
                        }
                        return;
                    }

                    var csrf = getCsrfToken();
                    var headers = {
                        "X-Requested-With": "XMLHttpRequest",
                        "Content-Type": "application/json"
                    };
                    if (csrf) {
                        headers["X-CSRFToken"] = csrf;
                    }

                    var ids = Array.prototype.map.call(checkboxes, function (cb) {
                        return cb.value;
                    });

                    // Send one request per selected project.
                    var promises = ids.map(function (id) {
                        var payload = {
                            base_url: gitlabUrl,
                            gitlab_api_token: gitlabToken,
                            project_id: id,
                            organization_id: org
                        };
                        return fetch(gitlabImportUrl, {
                            method: "POST",
                            credentials: "same-origin",
                            headers: headers,
                            body: JSON.stringify(payload)
                        }).then(function (resp) {
                            return resp.json().then(function (data) {
                                return {ok: resp.ok, data: data};
                            });
                        }).catch(function () {
                            return {ok: false, data: {error: "Network error"}};
                        });
                    });

                    Promise.all(promises).then(function (results) {
                        var failed = results.filter(function (r) {
                            return !r.ok;
                        });
                        if (failed.length && gitlabErrorBox) {
                            gitlabErrorBox.textContent =
                                "Some projects failed to import. Please check server logs.";
                            gitlabErrorBox.style.display = "block";
                            return;
                        }

                        // Close modal and reload page to show new projects.
                        if (window.jQuery && window.jQuery.fn.modal) {
                            window.jQuery(gitlabModal).modal("hide");
                        } else if (gitlabModal && gitlabModal.classList) {
                            gitlabModal.classList.remove("in");
                            gitlabModal.style.display = "none";
                        }

                        showGlobalAlert("Selected GitLab projects have been imported.", "success");
                        window.location.reload();
                    });
                });
            }

            var searchInput = document.getElementById("gitlab-projects-search");
            var imported_gitlab_projects_table = document.getElementById("gitlab-projects-table");

            if (searchInput && imported_gitlab_projects_table) {
                searchInput.addEventListener("keyup", function () {
                    var needle = (searchInput.value || "").toLowerCase();
                    var rows = imported_gitlab_projects_table.querySelectorAll("tbody tr");

                    Array.prototype.forEach.call(rows, function (row) {
                        var text = (row.textContent || "").toLowerCase();
                        row.style.display = (!needle || text.indexOf(needle) !== -1) ? "" : "none";
                    });
                });
            }


            // Delete project handler
            if (deleteBtn) {
                deleteBtn.addEventListener("click", function () {
                    if (!currentRow) return;

                    var deleteUrl = currentRow.getAttribute("data-delete-url");
                    if (!deleteUrl) return;

                    var confirmed = window.confirm(
                        "Are you sure you want to delete this project? This action cannot be undone."
                    );
                    if (!confirmed) {
                        return;
                    }

                    var csrf = getCsrfToken();
                    var headers = {
                        "X-Requested-With": "XMLHttpRequest"
                    };
                    if (csrf) {
                        headers["X-CSRFToken"] = csrf;
                    }

                    fetch(deleteUrl, {
                        method: "DELETE",
                        credentials: "same-origin",
                        headers: headers
                    }).then(function (resp) {
                        if (resp.status === 204) {
                            // Hide modal
                            if (window.jQuery && window.jQuery.fn.modal) {
                                window.jQuery(modal).modal("hide");
                            } else if (modal && modal.classList) {
                                modal.classList.remove("in");
                                modal.style.display = "none";
                            }

                            // Remove row from table
                            if (currentRow && currentRow.parentNode) {
                                currentRow.parentNode.removeChild(currentRow);
                            }
                            currentRow = null;

                            showGlobalAlert("Project has been deleted.", "success");
                        } else {
                            if (errorBox) {
                                errorBox.textContent = "Failed to delete project.";
                                errorBox.style.display = "block";
                            }
                        }
                    }).catch(function () {
                        if (errorBox) {
                            errorBox.textContent = "Unexpected error while deleting project.";
                            errorBox.style.display = "block";
                        }
                    });
                });
            }
        })();
    </script>
{% endblock %}
